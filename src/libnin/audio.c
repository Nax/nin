#include <libnin/libnin.h>

static const float kHyperbolicCoefficientsNTSC[] =
{
    0.00028486657730763284, 0.0006814671935866566, 0.0012530612169342585, 0.002000282223827972,
    0.0029210955318966893, 0.004010700051298972, 0.005261459018429627, 0.006662861417448858,
    0.008201515620390403, 0.009861176478374591, 0.011622806777302172, 0.013464673634176734,
    0.015362480057987907, 0.01728953153518949, 0.019216937127727877, 0.02111384419495965,
    0.02294770547342313, 0.024684576874146876, 0.026289443989891827, 0.0277265749483378,
    0.028959896905616594, 0.029953393151554108, 0.030671517497204412, 0.031079622340265275,
    0.031144396558095474, 0.03083430916441839, 0.030120054487235128, 0.028974994484528505,
    0.02737559371323116, 0.02530184240751529, 0.022737663106213123, 0.019671296297172524,
    0.01609566061923974, 0.012008683280570415, 0.007413596514866161, 0.0023191961042638956,
    -0.0032599417521638687, -0.00930328865355345, -0.015784240393956678, -0.02267004427004916,
    -0.0299217796264816, -0.03749439353160058, -0.04533679301479054, -0.05339199481153832,
    -0.06159733305767716, -0.06988472485455327, -0.07818099309673886, -0.08640824541820151,
    -0.09448430757649544, -0.10232320906259625, -0.10983571820153293, -0.11692992350103379,
    -0.12351185751699896, -0.12948615904061586, -0.13475676897707525, -0.13922765488463867,
    -0.14280355877950948, -0.1453907624905368, -0.14689786457185325, -0.14723656255435863,
    -0.14632243414134213, -0.14407571083186738, -0.14042203738973597, -0.1352932105673135,
    -0.12862789054313373, -0.1203722786403639, -0.1104807550597423, -0.09891647058476384,
    -0.08565188649743809, -0.07066925727807541, -0.0539610510499544, -0.03553030316655349,
    -0.015390898821991645, 0.006432218909373808, 0.029902918634776076, 0.05497383023985915,
    0.0815863763284061, 0.10967088666388199, 0.13914679610483582, 0.16992292584720972,
    0.20189784710137829, 0.23496032564626654, 0.2689898450232199, 0.30385720546448874,
    0.33942519500118384, 0.375549328569278, 0.41207865033532415, 0.44885659390153587,
    0.48572189452789416, 0.5225095470319192, 0.5590518025991084, 0.5951791973629307,
    0.6307216052962553, 0.6655093076993313, 0.6993740713755093, 0.7321502274568793,
    0.7636757427793347, 0.7937932757111936, 0.8223512084116719, 0.8492046476349191,
    0.874216386401072, 0.897257819126352, 0.9182098031375273, 0.9369634598894209,
    0.9534209096543728, 0.967495933955932, 0.9791145605713488, 0.9882155665240353,
    0.9947508951229955, 0.9986859837758676,
    1.0,
    0.9986859837758676, 0.9947508951229955,
    0.9882155665240353, 0.9791145605713488, 0.967495933955932, 0.9534209096543728,
    0.9369634598894209, 0.9182098031375273, 0.897257819126352, 0.874216386401072,
    0.8492046476349191, 0.8223512084116719, 0.7937932757111936, 0.7636757427793347,
    0.7321502274568793, 0.6993740713755093, 0.6655093076993313, 0.6307216052962553,
    0.5951791973629307, 0.5590518025991084, 0.5225095470319192, 0.48572189452789416,
    0.44885659390153587, 0.41207865033532415, 0.375549328569278, 0.33942519500118384,
    0.30385720546448874, 0.2689898450232199, 0.23496032564626654, 0.20189784710137829,
    0.16992292584720972, 0.13914679610483582, 0.10967088666388199, 0.0815863763284061,
    0.05497383023985915, 0.029902918634776076, 0.006432218909373808, -0.015390898821991645,
    -0.03553030316655349, -0.0539610510499544, -0.07066925727807541, -0.08565188649743809,
    -0.09891647058476384, -0.1104807550597423, -0.1203722786403639, -0.12862789054313373,
    -0.1352932105673135, -0.14042203738973597, -0.14407571083186738, -0.14632243414134213,
    -0.14723656255435863, -0.14689786457185325, -0.1453907624905368, -0.14280355877950948,
    -0.13922765488463867, -0.13475676897707525, -0.12948615904061586, -0.12351185751699896,
    -0.11692992350103379, -0.10983571820153293, -0.10232320906259625, -0.09448430757649544,
    -0.08640824541820151, -0.07818099309673886, -0.06988472485455327, -0.06159733305767716,
    -0.05339199481153832, -0.04533679301479054, -0.03749439353160058, -0.0299217796264816,
    -0.02267004427004916, -0.015784240393956678, -0.00930328865355345, -0.0032599417521638687,
    0.0023191961042638956, 0.007413596514866161, 0.012008683280570415, 0.01609566061923974,
    0.019671296297172524, 0.022737663106213123, 0.02530184240751529, 0.02737559371323116,
    0.028974994484528505, 0.030120054487235128, 0.03083430916441839, 0.031144396558095474,
    0.031079622340265275, 0.030671517497204412, 0.029953393151554108, 0.028959896905616594,
    0.0277265749483378, 0.026289443989891827, 0.024684576874146876, 0.02294770547342313,
    0.02111384419495965, 0.019216937127727877, 0.01728953153518949, 0.015362480057987907,
    0.013464673634176734, 0.011622806777302172, 0.009861176478374591, 0.008201515620390403,
    0.006662861417448858, 0.005261459018429627, 0.004010700051298972, 0.0029210955318966893,
    0.002000282223827972, 0.0012530612169342585, 0.0006814671935866566, 0.00028486657730763284
};

static const float kHyperbolicSumNTSC = 37.17702252436139f;

NIN_API void ninAudioSetCallback(NinState* state, NINAUDIOCALLBACK callback, void* arg)
{
    NinAudio* audio = &state->audio;

    audio->callback = callback;
    audio->callbackArg = arg;
}

NIN_API void ninAudioPushSample(NinState* state, float sample)
{
    NinAudio* audio = &state->audio;
    size_t i;
    size_t j;
    float acc;

    /* We push samples into a ring buffer */
    audio->samplesSrc[audio->samplesCursorSrc++] = sample;
    if (audio->samplesCursorSrc == AUDIO_BUFFER_SIZE_SOURCE_NTSC)
        audio->samplesCursorSrc = 0;

    audio->divider += 48000;
    if (audio->divider >= CLOCK_RATE_NTSC)
    {
        /* We need to generate a new sample */
        audio->divider -= CLOCK_RATE_NTSC;
        acc = 0;
        for (i = 0; i < AUDIO_BUFFER_SIZE_SOURCE_NTSC; ++i)
        {
            j = i + audio->samplesCursorSrc;
            if (j >= AUDIO_BUFFER_SIZE_SOURCE_NTSC)
                j -= AUDIO_BUFFER_SIZE_SOURCE_NTSC;
            acc += kHyperbolicCoefficientsNTSC[i] * audio->samplesSrc[j];
        }
        acc /= kHyperbolicSumNTSC;

        audio->samplesDst[audio->samplesCursorDst++] = (int16_t)(acc * 30000.f);
        if (audio->samplesCursorDst >= AUDIO_BUFFER_SIZE_TARGET)
        {
            audio->samplesCursorDst = 0;
            if (audio->callback)
                audio->callback(audio->callbackArg, audio->samplesDst);
        }
    }
}
